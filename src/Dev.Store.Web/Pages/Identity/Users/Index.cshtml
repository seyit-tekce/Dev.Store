@page
@using Dev.Store.Web.Pages.Identity.Roles;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Mvc.Localization;
@using System.Net;
@using Volo.Abp.AspNetCore.Mvc.UI.Layout;
@using Volo.Abp.Identity.Localization;
@using Volo.Abp.Identity.Web.Navigation;
@using Volo.Abp.Identity;
@model Dev.Store.Web.Pages.Identity.Roles.IndexModel
@inject IHtmlLocalizer<IdentityResource> L
@inject IPageLayout PageLayout
@inject IAuthorizationService Authorization
@{

    PageLayout.Content.Title = L["Users"].Value;
    PageLayout.Content.BreadCrumb.Add(L["Menu:IdentityManagement"].Value);
    var editPermission = await Authorization.IsGrantedAsync("AbpIdentity.Users.Update");
    var createPermission = await Authorization.IsGrantedAsync("AbpIdentity.Users.Create");
    var deletePermission = await Authorization.IsGrantedAsync("AbpIdentity.Users.Delete");
    var permissionsPermission = await Authorization.IsGrantedAsync("AbpIdentity.Users.ManagePermissions");
    PageLayout.Content.MenuItemName = IdentityMenuNames.Users;
}
@section styles {
    <abp-style-bundle name="@typeof(IndexModel).FullName">
        <abp-style src="/Pages/AbpPermissionManagement/permission-management-modal.css" />
    </abp-style-bundle>
}
@section scripts {
    <abp-script-bundle name="@typeof(IndexModel).FullName">
        <abp-script src="/client-proxies/identity-proxy.js" />
        <abp-script src="/Pages/AbpPermissionManagement/permission-management-modal.js" />
        <abp-script src="/Pages/Identity/Users/index.js" />
    </abp-script-bundle>
}
<abp-card>
    <abp-card-header>
        <abp-row>
            <abp-column size-md="_6">
                <abp-card-title>@L["Users"]</abp-card-title>
            </abp-column>
            <abp-column size-md="_6" class="text-end">
                @if (createPermission)
                {
                    <abp-button text="@L["NewUser"].Value" icon="plus" onclick="users.actions.create()" button-type="Primary" />

                }
            </abp-column>
        </abp-row>
    </abp-card-header>
    <abp-card-body>
        @(
            Html.Kendo().Grid<IdentityUserDto>()
            .Name("UsersGrid")
            .Columns(columns =>
            {
                columns.Command(command =>
                {
                    if (editPermission) command.Custom(L["Edit"].Value).Click("users.actions.edit");
                    if (permissionsPermission) command.Custom(L["Permissions"].Value).Click("users.actions.permissions");
                    if (editPermission) command.Custom(L["SetPassword"].Value).Click("users.actions.setPassword");
                    if (deletePermission) command.Custom(L["Delete"].Value).Click("users.actions.delete");

                });
                columns.Bound(c => c.Name).Title(L["Name"].Value);
                columns.Bound(c => c.Surname).Title(L["Surname"].Value);
                columns.Bound(c => c.CreationTime).Title(L["CreationTime"].Value).Format(Dev.Store.KendoHelper.DateTimeShortFormat);
                columns.Bound(c => c.UserName).Title(L["UserName"].Value);
                columns.Bound(c => c.Email).Width(200).Title(L["Email"].Value);
                columns.Bound(c => c.PhoneNumber).Width(130).Title(L["PhoneNumber"].Value);
            })
            .ToolBar(tools =>
            {
                tools.Search().Text(" ");
                tools.Excel().Text(" ");
                tools.Pdf().Text(" ");
            })
            .Height(650)
            .Scrollable(x => x.Height(650))
            .Sortable()
            .Selectable()
            .Pageable(x => x.Refresh(true))
            .Filterable()
            .Events(a => a.DataBound("kendoGrid.events.databound")
            .Edit("kendoGrid.events.edit")
            .Cancel("kendoGrid.events.cancel")
            .CellClose("kendoGrid.events.cellClose")
            .Change("kendoGrid.events.change"))
            .DataSource(dataSource => dataSource
            .WebApi()
            .Model(model =>
            {
                model.Id(p => p.Id);
            })
            .Read(read => read.Url("/api/app/user/data-source"))
            ).Deferred()
            )



    </abp-card-body>
</abp-card>
