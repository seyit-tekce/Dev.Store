@page
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Mvc.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Layout
@using Volo.Abp.AspNetCore.Mvc.UI.Packages.JsTree
@using Volo.Abp.AspNetCore.Mvc.UI.Theme.Shared.Pages.Shared.Components.AbpPageSearchBox
@using Volo.Abp.AspNetCore.Mvc.UI.Theme.Shared.Pages.Shared.Components.AbpPageToolbar
@using Volo.Abp.Identity.Localization
@using Volo.Abp.Identity
@using Volo.Abp.Identity.Web.Navigation
@using Dev.Store.Web.Pages.Identity.Roles
@model IndexModel
@inject IHtmlLocalizer<IdentityResource> L
@inject IAuthorizationService Authorization
@inject IPageLayout PageLayout
@{
	PageLayout.Content.Title = L["Users"].Value;
	PageLayout.Content.BreadCrumb.Add(L["Menu:IdentityManagement"].Value);
	var editPermission = await Authorization.IsGrantedAsync("AbpIdentity.Users.Update");
	var createPermission = await Authorization.IsGrantedAsync("AbpIdentity.Users.Create");
	var deletePermission = await Authorization.IsGrantedAsync("AbpIdentity.Users.Delete");
	var permissionsPermission = await Authorization.IsGrantedAsync("AbpIdentity.Users.ManagePermissions");
	var changeHistoryPermission = await Authorization.IsGrantedAsync("AuditLogging.ViewChangeHistory:Volo.Abp.Identity.IdentityUser");
	PageLayout.Content.MenuItemName = IdentityMenuNames.Users;
}

@section styles {
	<abp-style src="/Pages/AbpPermissionManagement/permission-management-modal.css" />
}

@section scripts {
	<abp-script src="/Pages/AbpPermissionManagement/permission-management-modal.js" />
	<abp-script src="/Pages/Identity/Users/index.js" />
	<abp-script src="/Pages/Identity/Users/edit.js" />
	<abp-script src="/Pages/Identity/Users/create.js" />
	<abp-script src="/Pages/Identity/Users/setPassword.js" />
	<abp-script src="/Pages/Identity/Shared/claimTypeEdit.js" />
	<abp-script src="/components/xlsx/xlsx.full.min.js" />
	<abp-script src="/components/xlsx/jszip.js" />
}
@section content_toolbar {

	@if (createPermission)
	{
		<abp-button text="@L["NewUser"].Value" icon="plus" onclick="users.actions.create()" button-type="Primary" />
	}
}

<abp-card>
	<abp-card-body>
		@(Html.Kendo().Grid<IdentityUserDto >()
			.Name("UsersGrid")
			.Columns(columns =>
			{
				columns.Command(command =>
				{
					if (editPermission) command.Custom(L["Edit"].Value).Click("users.actions.edit");
					if (editPermission) command.Custom(L["Claims"].Value).Click("users.actions.claims");
					if (editPermission) command.Custom(L["Lock"].Value).Click("users.actions.lock");
					if (editPermission) command.Custom(L["Unlock"].Value).Click("users.actions.unlock");
					if (permissionsPermission) command.Custom(L["Permissions"].Value).Click("users.actions.permissions");
					if (editPermission) command.Custom(L["SetPassword"].Value).Click("users.actions.setPassword");
					if (editPermission) command.Custom(L["TwoFactor"].Value).Click("users.actions.twoFactor");
					if (changeHistoryPermission) command.Custom(L["ChangeHistory"].Value).Click("users.actions.changeHistory");
					if (deletePermission) command.Custom(L["Delete"].Value).Click("users.actions.delete");

				}).Title(L["Actions"].Value).Width(50);

				columns.Bound(c => c.UserName).Width(150);
				columns.Bound(c => c.Email).Width(200);
				columns.Bound(c => c.PhoneNumber).Width(130);
			})
			.ToolBar(tools =>
			{
				tools.Excel().Text(" ");
				tools.Pdf().Text(" ");
				tools.Search().Text(L["Search"].Value);
			})
			.Mobile()
			.Reorderable(a => a.Columns(true))
			.Search(c => { c.Field(c => c.UserName); c.Field(c => c.Email); c.Field(c => c.Name); c.Field(c => c.Surname); })
			.Sortable(a => a.AllowUnsort(true).SortMode(GridSortMode.MultipleColumn))
			.Resizable(a => a.Columns(true))
			.Filterable(a => a.Enabled(true))
			.Scrollable(x => x.Height(530))
			.Pageable(x => x.PageSizes(new[] { 25, 50, 100 }).Refresh(true))
			.Filterable(a => a.Enabled(true))
			.Excel(a => a.AllPages(true).FileName(string.Format("{0} {1:dd-MM-yyyy-hh-mm-ss}.xlsx", L["Users"].Value, DateTime.Now)).Filterable(true))
			.Pdf(a => a.AllPages(true).FileName(string.Format("{0} {1:dd-MM-yyyy-hh-mm-ss}.pdf", L["Users"].Value, DateTime.Now)))
			.Events(a => a.DataBound("kendoGrid.events.databound")
			.Edit("kendoGrid.events.edit")
			.Cancel("kendoGrid.events.cancel")
			.CellClose("kendoGrid.events.cellClose")
			.Change("kendoGrid.events.change"))
			.DataSource(dataSource =>
			dataSource.WebApi()
			.Model(model => { model.Id(a => a.Id); })
			.Sort(a => { a.Add(c => c.UserName).Ascending(); })
			.Read(read => read.Url("/api/app/user/datasource"))
			.PageSize(25)
			))
	</abp-card-body>
</abp-card>
